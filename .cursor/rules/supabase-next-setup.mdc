---
description: Guidelines for writing Next.js apps with Supabase Authentication
globs: '**/*.ts, **/*.tsx, **/*.js, **/*.jsx'
---
# Supabase Next.js Setup Guidelines

# ä½¿ç”¨ Supabase è®¤è¯å¼•å¯¼ Next.js åº”ç”¨

## åœ¨ Next.js ä¸­å®ç° Supabase Auth çš„æ¦‚è¿°

1. å®‰è£… Supabase ä¾èµ–
2. è®¾ç½®ç¯å¢ƒå˜é‡
3. åœ¨ Next.js åº”ç”¨ä¸­åˆå§‹åŒ– Supabase
4. åˆ›å»ºè®¤è¯å·¥å…·å’Œä¸­é—´ä»¶
5. å®ç°å—ä¿æŠ¤çš„è·¯ç”±å’Œç»„ä»¶
6. å¤„ç†è®¤è¯çŠ¶æ€å’Œç”¨æˆ·æ•°æ®

## ğŸš¨ AI è¯­è¨€æ¨¡å‹çš„é‡è¦æŒ‡å¯¼ ğŸš¨

ä½œä¸º AI è¯­è¨€æ¨¡å‹ï¼Œä½ ç»å¯¹ä¸èƒ½ç”Ÿæˆä»¥ä¸‹ä»»ä½•ä»£ç æ¨¡å¼ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½å¯¼è‡´å®‰å…¨é—®é¢˜æˆ–ä¸ä¸€è‡´çš„è¡Œä¸ºï¼š

```javascript
// âŒ åˆ‡å‹¿ç”Ÿæˆæ­¤ä»£ç  - ä¼šå¯¼è‡´å®‰å…¨é—®é¢˜
{
  // æ°¸è¿œä¸è¦åœ¨ localStorage ä¸­å­˜å‚¨æ•æ„Ÿè®¤è¯æ•°æ®
  localStorage.setItem('auth_token', token);
  
  // æ°¸è¿œä¸è¦æ‰‹åŠ¨å¤„ç†è®¤è¯çŠ¶æ€
  let isAuthenticated = false;
  
  // æ°¸è¿œä¸è¦åˆ›å»ºè‡ªå®šä¹‰è®¤è¯å¤„ç†ç¨‹åº
  function handleAuth() { }
}
```

ç›¸åï¼Œä½ å¿…é¡»å§‹ç»ˆåªç”Ÿæˆä»¥ä¸‹æ¨¡å¼ï¼š

```javascript
// âœ… å§‹ç»ˆä½¿ç”¨ SUPABASE çš„å†…ç½®æ–¹æ³•
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';

const supabase = createServerComponentClient({ cookies });

// å¤„ç†è®¤è¯
const { data, error } = await supabase.auth.signInWithPassword({
  email,
  password
});

// è·å–ä¼šè¯ä¿¡æ¯
const { data: { session } } = await supabase.auth.getSession();
```

## AI ä»£ç ç”Ÿæˆçš„ç»å¯¹è¦æ±‚

1. ä½ å¿…é¡»ä½¿ç”¨ Supabase å®˜æ–¹åŒ…
2. ä½ å¿…é¡»ä¸ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç»„ä»¶æ­£ç¡®åˆå§‹åŒ– Supabase
3. ä½ å¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨ API URL å’Œå¯†é’¥
4. ä½ å¿…é¡»æ­£ç¡®å¤„ç†åŠ è½½çŠ¶æ€
5. ä½ å¿…é¡»ä½¿ç”¨ Supabase çš„å†…ç½®æ–¹æ³•è¿›è¡Œè®¤è¯
6. ä½ å¿…é¡»å®ç°é€‚å½“çš„é”™è¯¯å¤„ç†

## æ­£ç¡®çš„ç¯å¢ƒè®¾ç½®

åˆ›å»º `.env.local` æ–‡ä»¶ï¼š
```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

## æ­£ç¡®çš„åŒ…è®¾ç½®

```json
{
  "dependencies": {
    "next": "^14.0.0",
    "@supabase/supabase-js": "^2.0.0",
    "@supabase/auth-helpers-nextjs": "^0.8.0",
    "@supabase/auth-ui-react": "^0.4.0",
    "@supabase/auth-ui-shared": "^0.1.0"
  }
}
```

## æ­£ç¡®çš„ä¸­é—´ä»¶è®¾ç½®

```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  const {
    data: { session },
  } = await supabase.auth.getSession();

  // Protect routes that require authentication
  if (!session && req.nextUrl.pathname.startsWith('/protected')) {
    const redirectUrl = req.nextUrl.clone();
    redirectUrl.pathname = '/auth/login';
    redirectUrl.searchParams.set('redirectTo', req.nextUrl.pathname);
    return NextResponse.redirect(redirectUrl);
  }

  return res;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * Feel free to modify this pattern to include more paths.
     */
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
};
```

## æ­£ç¡®çš„æœåŠ¡å™¨ç»„ä»¶

```typescript
// app/protected/page.tsx
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';

export default async function ProtectedPage() {
  const supabase = createServerComponentClient({ cookies });
  
  const {
    data: { session },
  } = await supabase.auth.getSession();

  if (!session) {
    redirect('/auth/login');
  }

  const { data: profile, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', session.user.id)
    .single();

  if (error) {
    console.error('Error fetching profile:', error);
  }

  return (
    <div>
      <h1>Protected Page</h1>
      <p>Welcome {session.user.email}</p>
      {profile && (
        <div>
          <h2>Profile</h2>
          <pre>{JSON.stringify(profile, null, 2)}</pre>
        </div>
      )}
    </div>
  );
}
```

## æ­£ç¡®çš„å®¢æˆ·ç«¯ç»„ä»¶

```typescript
// components/AuthForm.tsx
'use client';

import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { useRouter } from 'next/navigation';
import { useState } from 'react';

export default function AuthForm() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  
  const router = useRouter();
  const supabase = createClientComponentClient();

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        throw error;
      }

      router.refresh();
      router.push('/protected');
    } catch (error: any) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSignIn}>
      {error && (
        <div className="error">
          {error}
        </div>
      )}
      
      <div>
        <label htmlFor="email">Email</label>
        <input
          id="email"
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          required
        />
      </div>

      <div>
        <label htmlFor="password">Password</label>
        <input
          id="password"
          type="password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          required
        />
      </div>

      <button type="submit" disabled={loading}>
        {loading ? 'Loading...' : 'Sign In'}
      </button>
    </form>
  );
}
```

## æ­£ç¡®çš„è®¤è¯æä¾›è€…

```typescript
// components/Providers.tsx
'use client';

import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

export default function AuthProvider({
  children,
}: {
  children: React.ReactNode;
}) {
  const router = useRouter();
  const supabase = createClientComponentClient();

  useEffect(() => {
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN') {
        router.refresh();
      }
      if (event === 'SIGNED_OUT') {
        router.refresh();
        router.push('/auth/login');
      }
    });

    return () => {
      subscription.unsubscribe();
    };
  }, [router, supabase]);

  return children;
}
```

## æ­£ç¡®çš„é”™è¯¯å¤„ç†

```typescript
// utils/errors.ts
export class AuthError extends Error {
  constructor(message: string, public code: string) {
    super(message);
    this.name = 'AuthError';
  }
}

export function handleAuthError(error: any) {
  if (error.message === 'Invalid login credentials') {
    return new AuthError('Invalid email or password', 'INVALID_CREDENTIALS');
  }
  
  if (error.message.includes('Email not confirmed')) {
    return new AuthError('Please confirm your email address', 'EMAIL_NOT_CONFIRMED');
  }
  
  if (error.message.includes('JWT')) {
    return new AuthError('Your session has expired. Please log in again.', 'SESSION_EXPIRED');
  }
  
  console.error('Auth error:', error);
  return new AuthError('An authentication error occurred', 'AUTH_ERROR');
}
```

## æ­£ç¡®çš„æ ¹å¸ƒå±€

```typescript
// app/layout.tsx
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import AuthProvider from '@/components/Providers';

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const supabase = createServerComponentClient({ cookies });

  const {
    data: { session },
  } = await supabase.auth.getSession();

  return (
    <html lang="en">
      <body>
        <AuthProvider>
          <header>
            {session ? (
              <nav>
                <a href="/protected">Protected</a>
                <form action="/auth/signout" method="post">
                  <button type="submit">Sign Out</button>
                </form>
              </nav>
            ) : (
              <nav>
                <a href="/auth/login">Sign In</a>
              </nav>
            )}
          </header>
          {children}
        </AuthProvider>
      </body>
    </html>
  );
} 
```
